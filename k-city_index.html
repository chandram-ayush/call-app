<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-City Multi-Cam</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { 
            background: #000; color: #fff; 
            font-family: sans-serif; 
            text-align: center; 
            display: flex; flex-direction: column; 
            height: 100vh; margin: 0; overflow: hidden; 
        }
        
        /* Layouts */
        .vid-wrapper { 
            position: relative; width: 100%; 
            height: 100%; display: flex; 
            flex-direction: column; justify-content: center; 
            align-items: center; 
        }
        video { 
            width: 100%; max-height: 80vh; 
            background: #111; border-radius: 8px; 
        }
        
        /* Buttons */
        .btn { 
            padding: 15px 25px; font-size: 16px; 
            border: none; border-radius: 30px; 
            cursor: pointer; margin: 15px; 
            font-weight: bold; text-transform: uppercase; 
            letter-spacing: 1px; width: 80%; 
            max-width: 300px; transition: transform 0.1s; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
        }
        .btn:active { transform: scale(0.95); }
        .btn-cam { background: linear-gradient(135deg, #e91e63, #c2185b); color: white; }
        .btn-watch { background: linear-gradient(135deg, #2196f3, #1976d2); color: white; }
        .btn-end { background: linear-gradient(135deg, #ff4444, #cc0000); color: white; margin-top: 20px; }
        
        /* Inputs */
        input.cam-name {
            padding: 15px; border-radius: 30px; border: 1px solid #444;
            background: #222; color: white; width: 70%; max-width: 250px;
            text-align: center; font-size: 16px; margin-bottom: 20px;
        }

        /* Lists */
        #camera-list {
            width: 100%; max-width: 400px; margin: 0 auto;
            max-height: 60vh; overflow-y: auto;
        }
        .cam-item {
            background: #222; margin: 10px; padding: 15px;
            border-radius: 10px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #333;
        }
        .cam-item:hover { background: #333; border-color: #00e676; }
        .cam-name { font-weight: bold; color: #fff; }
        .cam-viewers { font-size: 12px; color: #aaa; }

        .hidden { display: none !important; }

        /* Console */
        #console { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            height: 80px; background: rgba(0,0,0,0.8); 
            font-family: monospace; font-size: 10px; color: #0f0; 
            overflow-y: scroll; text-align: left; 
            padding: 5px; pointer-events: none; 
            border-top: 1px solid #333; 
        }
        
        .viewer-count {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,230,118,0.2); border: 1px solid #00e676;
            padding: 8px 12px; border-radius: 20px; font-size: 12px;
        }
    </style>
</head>
<body>

    <div id="select-screen">
        <h2 style="margin-top: 50px; letter-spacing: 2px;">K-CITY LINK</h2>
        
        <div style="margin-bottom: 40px; border-bottom: 1px solid #333; padding-bottom: 20px;">
            <input type="text" id="cameraNameInput" class="cam-name" placeholder="Enter Camera Name">
            <br>
            <button class="btn btn-cam" onclick="startCameraMode()">Start Camera üì∑</button>
        </div>

        <div>
            <button class="btn btn-watch" onclick="openViewerLobby()">Watch Stream üëÄ</button>
        </div>
    </div>

    <div id="viewer-lobby" class="hidden">
        <h3>Live Cameras</h3>
        <div id="camera-list">
            <p style="color: #666;">Searching for cameras...</p>
        </div>
        <button class="btn btn-end" onclick="location.reload()">Back</button>
    </div>

    <div id="broadcaster-screen" class="hidden vid-wrapper">
        <h3 style="color: #aaa;">BROADCASTER</h3>
        <div class="viewer-count" id="host-viewer-count">Viewers: 0</div>
        <p style="color: #666; font-size: 12px;" id="status-text">Waiting for viewers...</p>
        <video id="localVideo" muted playsinline autoplay style="display: none;"></video>
        <button class="btn btn-end" onclick="location.reload()">Stop Stream</button>
    </div>

    <div id="caller-screen" class="hidden vid-wrapper">
        <video id="remoteVideo" playsinline autoplay></video>
        <div class="viewer-count">üñ•Ô∏è Watching</div>
        <button class="btn btn-end" onclick="location.reload()">Leave Stream</button>
    </div>

    <div id="console"></div>

    <script>
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'turn:openrelay.metered.ca:80', username: "openrelayproject", credential: "openrelayproject" }
            ]
        };

        let socket = io();
        let peerConnections = {}; // For Broadcaster: { viewer_id: Peer }
        let currentPeer = null;   // For Viewer: Single Peer
        let localStream = null;
        let activeViewers = 0;
        let myRole = null; // 'broadcaster' or 'viewer'

        function log(msg) {
            const c = document.getElementById('console');
            const d = document.createElement('div');
            d.innerText = `> ${msg}`;
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
        }

        // --- 1. SETUP FLOWS ---

        // Start as Camera
        async function startCameraMode() {
            const name = document.getElementById('cameraNameInput').value || "Unnamed Cam";
            myRole = 'broadcaster';
            
            document.getElementById('select-screen').classList.add('hidden');
            document.getElementById('broadcaster-screen').classList.remove('hidden');

            // Prevent screen sleep
            try { await navigator.wakeLock.request('screen'); } catch(e){}

            socket.emit('register_broadcaster', name);
            log(`üì° Registered as "${name}"`);
        }

        // Start as Viewer (Open Lobby)
        function openViewerLobby() {
            myRole = 'viewer';
            document.getElementById('select-screen').classList.add('hidden');
            document.getElementById('viewer-lobby').classList.remove('hidden');
            socket.emit('get_cameras');
        }

        // --- 2. SOCKET EVENTS ---

        // Update Camera List (Lobby)
        socket.on('camera_list_update', (cameras) => {
            if (myRole !== 'viewer') return; // Only viewers care about this list

            const listDiv = document.getElementById('camera-list');
            listDiv.innerHTML = '';

            if (cameras.length === 0) {
                listDiv.innerHTML = '<p style="color: #666; margin-top: 20px;">No cameras active.</p>';
                return;
            }

            cameras.forEach(cam => {
                const item = document.createElement('div');
                item.className = 'cam-item';
                item.innerHTML = `
                    <span class="cam-name">üì∑ ${cam.name}</span>
                    <span class="cam-viewers">üë• ${cam.viewers}</span>
                `;
                item.onclick = () => selectCamera(cam.id);
                listDiv.appendChild(item);
            });
        });

        // Viewer selects a camera
        function selectCamera(targetId) {
            document.getElementById('viewer-lobby').classList.add('hidden');
            document.getElementById('caller-screen').classList.remove('hidden');
            log("Connecting to camera...");
            socket.emit('join_stream', targetId);
        }

        // --- 3. BROADCASTER LOGIC ---

        // A viewer selected this camera
        socket.on('watcher_joined', async (viewerId) => {
            log(`üìû Viewer ${viewerId} joined`);
            activeViewers++;
            updateHostUI();

            // Start camera if not already running
            if (!localStream) {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
                    document.getElementById('localVideo').srcObject = localStream;
                } catch(e) {
                    log("‚ùå Cam Error: " + e.message);
                    return;
                }
            }

            // Create Peer for this specific viewer
            const peer = new RTCPeerConnection(config);
            peerConnections[viewerId] = peer;

            localStream.getTracks().forEach(track => peer.addTrack(track, localStream));

            peer.onicecandidate = event => {
                if (event.candidate) socket.emit('candidate', viewerId, event.candidate);
            };

            const offer = await peer.createOffer();
            await peer.setLocalDescription(offer);
            socket.emit('offer', viewerId, peer.localDescription);
        });

        socket.on('viewer_left', (viewerId) => {
            if (peerConnections[viewerId]) {
                peerConnections[viewerId].close();
                delete peerConnections[viewerId];
                activeViewers--;
                updateHostUI();
                log(`üëã Viewer ${viewerId} left`);
            }
        });

        socket.on('all_viewers_left', () => {
            log("üí§ All viewers gone. Stopping camera.");
            if (localStream) {
                localStream.getTracks().forEach(t => t.stop());
                localStream = null;
            }
            activeViewers = 0;
            updateHostUI();
        });

        socket.on('answer', (viewerId, desc) => {
            if (peerConnections[viewerId]) peerConnections[viewerId].setRemoteDescription(desc);
        });

        socket.on('candidate', (viewerId, cand) => {
            if (peerConnections[viewerId]) peerConnections[viewerId].addIceCandidate(new RTCIceCandidate(cand));
        });

        function updateHostUI() {
            document.getElementById('host-viewer-count').innerText = `Viewers: ${activeViewers}`;
            document.getElementById('status-text').innerText = activeViewers > 0 ? "‚óè LIVE STREAMING" : "Waiting for viewers (Cam off)";
        }

        // --- 4. VIEWER LOGIC ---

        socket.on('offer', async (broadcasterId, description) => {
            // BroadcasterId comes as a tuple/array sometimes depending on server emit, 
            // but here we just need the description to set up the viewing peer
            // In this code structure, `broadcasterId` is actually the ID of the person sending the offer
            
            const peer = new RTCPeerConnection(config);
            currentPeer = peer;

            peer.ontrack = event => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };

            peer.onicecandidate = event => {
                if (event.candidate) socket.emit('candidate', broadcasterId, event.candidate);
            };

            await peer.setRemoteDescription(description);
            const answer = await peer.createAnswer();
            await peer.setLocalDescription(answer);
            socket.emit('answer', broadcasterId, peer.localDescription);
        });

        socket.on('broadcaster_left', () => {
            alert("The camera disconnected.");
            location.reload();
        });

        socket.on('error', (msg) => {
            alert(msg);
            location.reload();
        });

    </script>
</body>
</html>