<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K-City Multi-View</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00f2ff; --danger: #ff0055; --bg: #0a0a0a; --glass: rgba(255, 255, 255, 0.05); }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* UI Elements */
        h1 { font-weight: 800; letter-spacing: -1px; margin-bottom: 5px; font-size: 2rem; background: linear-gradient(to right, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-grid { display: grid; gap: 15px; width: 90%; max-width: 320px; margin-top: 30px; }
        .btn { border: none; padding: 18px; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn:active { transform: scale(0.96); }
        .btn-cam { background: var(--glass); color: var(--primary); border: 1px solid rgba(0, 242, 255, 0.3); }
        .btn-watch { background: var(--glass); color: #fff; border: 1px solid rgba(255, 255, 255, 0.2); }
        .btn-end { background: var(--danger); color: white; margin-top: 20px; padding: 10px 30px; border-radius: 30px; }

        /* Viewer Count Badge */
        .live-badge { 
            position: absolute; top: 20px; left: 20px; z-index: 100;
            background: rgba(255, 0, 0, 0.8); color: white; 
            padding: 5px 12px; border-radius: 4px; font-weight: bold; font-size: 0.8rem;
            display: flex; align-items: center; gap: 6px;
        }
        .live-dot { width: 8px; height: 8px; background: white; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* Video Area */
        .vid-container { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Stealth Overlay */
        #stealth { position: fixed; inset: 0; background: #000; z-index: 999; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        #stealth span { color: #333; font-size: 10px; animation: fadeOut 4s forwards; }
        @keyframes fadeOut { to { opacity: 0; } }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="home" class="fade-in">
        <h1>K-CITY LINK</h1>
        <p>Multi-Viewer Secure System</p>
        <div class="btn-grid">
            <button class="btn btn-cam" onclick="startBroadcasterMode()"><span>üì∑</span> I am Camera</button>
            <button class="btn btn-watch" onclick="startViewerMode()"><span>üëÄ</span> I am Viewer</button>
        </div>
    </div>

    <div id="standby" class="hidden fade-in" style="text-align: center;">
        <div style="font-size: 3rem; margin-bottom: 20px;">üõ°Ô∏è</div>
        <h1>SYSTEM ARMED</h1>
        <p>Standby Mode Active</p>
        <p style="margin-top: 30px; font-size: 0.8rem; opacity: 0.5;">Screen is Awake.<br>Camera OFF until viewer connects.</p>
    </div>

    <div id="viewer" class="hidden vid-container">
        <div class="live-badge">
            <div class="live-dot"></div>
            <span id="view-count">0</span> Viewers
        </div>
        
        <video id="remoteVideo" autoplay playsinline></video>
        <div style="position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center;">
            <button class="btn btn-end" onclick="endCall()">Leave Stream</button>
        </div>
    </div>

    <video id="localVideo" muted playsinline autoplay style="display: none;"></video>

    <div id="stealth" class="hidden" ondblclick="toggleStealth()">
        <div class="live-badge" style="top: 50%; left: 50%; transform: translate(-50%, -50%); background: none;">
            <span id="stealth-count" style="color: #333; font-size: 2rem;">0</span>
        </div>
        <span style="position: absolute; bottom: 50px;">Recording Active. Double Tap to Wake.</span>
    </div>

    <script>
        const socket = io();
        const config = { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] };
        
        let localStream = null;
        let wakeLock = null;
        
        // Broadcaster manages MULTIPLE connections: { 'socketId': RTCPeerConnection }
        const peerConnections = {}; 

        // --- COMMON LOGIC ---
        socket.on('update_count', (count) => {
            document.getElementById('view-count').innerText = count;
            document.getElementById('stealth-count').innerText = count;
        });

        // --- BROADCASTER LOGIC ---
        async function startBroadcasterMode() {
            document.getElementById('home').classList.add('hidden');
            document.getElementById('standby').classList.remove('hidden');
            
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
            socket.emit('broadcaster');

            // Permission warmup
            try { 
                const t = await navigator.mediaDevices.getUserMedia({video:true});
                t.getTracks().forEach(tr => tr.stop());
            } catch(e) { alert("Please Allow Camera Permissions!"); }
        }

        socket.on('watcher', async (id) => {
            // 1. START CAMERA (If not already running)
            if (!localStream) {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
                    document.getElementById('localVideo').srcObject = localStream;
                    document.getElementById('stealth').classList.remove('hidden'); // Enter Stealth
                } catch(e) { 
                    alert("Cam Start Failed: " + e.message); 
                    return; 
                }
            }

            // 2. CREATE PEER CONNECTION FOR *THIS* VIEWER
            const peer = new RTCPeerConnection(config);
            peerConnections[id] = peer; // Store it using Viewer ID

            localStream.getTracks().forEach(track => peer.addTrack(track, localStream));

            peer.onicecandidate = e => { if(e.candidate) socket.emit('candidate', id, e.candidate); };
            
            const offer = await peer.createOffer();
            await peer.setLocalDescription(offer);
            socket.emit('offer', id, peer.localDescription);
        });

        socket.on('answer', (id, desc) => {
            if(peerConnections[id]) peerConnections[id].setRemoteDescription(desc);
        });

        socket.on('candidate', (id, cand) => {
            if(peerConnections[id]) peerConnections[id].addIceCandidate(new RTCIceCandidate(cand));
        });
        
        // HANDLE VIEWER DISCONNECT
        socket.on('disconnectPeer', (id) => {
            // Close specific connection
            if(peerConnections[id]) {
                peerConnections[id].close();
                delete peerConnections[id];
            }

            // CHECK: Are there any viewers left?
            if (Object.keys(peerConnections).length === 0) {
                console.log("No viewers left. Stopping Camera.");
                
                // Stop Camera Hardware
                if(localStream) { 
                    localStream.getTracks().forEach(t => t.stop()); 
                    localStream = null; 
                }
                
                // Exit Stealth, go back to Standby
                document.getElementById('stealth').classList.add('hidden');
            }
        });

        function toggleStealth() { document.getElementById('stealth').classList.add('hidden'); }

        // --- VIEWER LOGIC ---
        let viewerPeer = null;

        function startViewerMode() {
            document.getElementById('home').classList.add('hidden');
            document.getElementById('viewer').classList.remove('hidden');
            socket.emit('watcher');
        }

        socket.on('offer', async (id, desc) => {
            viewerPeer = new RTCPeerConnection(config);
            viewerPeer.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
            viewerPeer.onicecandidate = e => { if(e.candidate) socket.emit('candidate', id, e.candidate); };
            
            await viewerPeer.setRemoteDescription(desc);
            const answer = await viewerPeer.createAnswer();
            await viewerPeer.setLocalDescription(answer);
            socket.emit('answer', id, viewerPeer.localDescription);
        });

        socket.on('broadcaster_left', () => {
            alert("Broadcaster went offline.");
            location.reload();
        });

        function endCall() {
            socket.disconnect();
            location.reload();
        }
    </script>
</body>
</html>