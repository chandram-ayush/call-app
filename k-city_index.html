<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-City Ultimate (Multi-Viewer)</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { 
            background: #000; color: #fff; 
            font-family: sans-serif; 
            text-align: center; 
            display: flex; flex-direction: column; 
            height: 100vh; margin: 0; overflow: hidden; 
        }
        
        /* Layouts */
        .vid-wrapper { 
            position: relative; width: 100%; 
            height: 100%; display: flex; 
            flex-direction: column; justify-content: center; 
            align-items: center; 
        }
        video { 
            width: 100%; max-height: 80vh; 
            background: #111; border-radius: 8px; 
        }
        
        /* Buttons */
        .btn { 
            padding: 15px 25px; font-size: 16px; 
            border: none; border-radius: 30px; 
            cursor: pointer; margin: 15px; 
            font-weight: bold; text-transform: uppercase; 
            letter-spacing: 1px; width: 80%; 
            max-width: 300px; transition: transform 0.1s; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
        }
        .btn:active { transform: scale(0.95); }
        .btn-cam { 
            background: linear-gradient(135deg, #e91e63, #c2185b); 
            color: white; 
        }
        .btn-watch { 
            background: linear-gradient(135deg, #2196f3, #1976d2); 
            color: white; 
        }
        .btn-end { 
            background: linear-gradient(135deg, #ff4444, #cc0000); 
            color: white; margin-top: 20px; 
        }
        
        /* Status */
        .status-pulse { 
            color: #00e676; font-size: 14px; 
            animation: pulse 2s infinite; margin-top: 20px; 
        }
        @keyframes pulse { 
            0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } 
        }

        .hidden { display: none !important; }

        /* Stealth Mode */
        #stealth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 99999; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        #stealth-text { 
            color: #111; font-size: 10px; 
            animation: fadeOut 5s forwards; 
        }
        @keyframes fadeOut { 
            0% { opacity: 1; } 100% { opacity: 0; } 
        }

        /* Viewer Count */
        .viewer-count {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,230,118,0.2); border: 1px solid #00e676;
            padding: 8px 12px; border-radius: 20px; font-size: 12px;
            font-weight: bold;
        }

        /* Console */
        #console { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            height: 80px; background: rgba(0,0,0,0.8); 
            font-family: monospace; font-size: 10px; color: #0f0; 
            overflow-y: scroll; text-align: left; 
            padding: 5px; pointer-events: none; 
            border-top: 1px solid #333; 
        }
    </style>
</head>
<body>

    <div id="select-screen">
        <h2 style="margin-top: 50px; letter-spacing: 2px;">K-CITY LINK</h2>
        <button class="btn btn-cam" onclick="initBroadcasterMode()">Camera üì∑</button>
        <button class="btn btn-watch" onclick="initCallerMode()">Viewer üëÄ</button>
    </div>

    <div id="broadcaster-screen" class="hidden vid-wrapper">
        <h3 style="color: #aaa;">STANDBY MODE</h3>
        <div class="status-pulse" id="broadcaster-status">‚óè Connected to Server</div>
        <div class="viewer-count" id="viewer-count">Viewers: 0</div>
        <p style="color: #666; font-size: 12px; max-width: 80%;">
            Waiting for viewers...<br>
            Camera OFF to save battery.
        </p>
        <video id="localVideo" muted playsinline autoplay style="display: none;"></video>
    </div>

    <div id="caller-screen" class="hidden vid-wrapper">
        <video id="remoteVideo" playsinline autoplay></video>
        <div class="viewer-count">üñ•Ô∏è Viewer Mode</div>
        <button class="btn btn-end" onclick="endCall()">End Call</button>
    </div>

    <div id="stealth-overlay" class="hidden" ondblclick="wakeUpScreen()">
        <div id="stealth-text">System Active. Double Tap to Wake.</div>
    </div>

    <div id="console"></div>

    <script>
        // ‚úÖ WORKING TURN SERVERS
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                {
                    urls: [
                        'turn:openrelay.metered.ca:80',
                        'turn:openrelay.metered.ca:443',
                        'turn:openrelay.metered.ca:443?transport=tcp'
                    ],
                    username: "openrelayproject",
                    credential: "openrelayproject"
                }
            ]
        };

        let socket = null;
        let peerConnections = {};  // Multiple viewers = multiple peer connections
        let localStream = null;
        let wakeLock = null;
        let activeViewers = 0;

        function log(msg) {
            const c = document.getElementById('console');
            const d = document.createElement('div');
            d.innerText = `> ${msg}`;
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
        }

        // Initialize Socket
        socket = io();
        log("üîå Server Connected");

        // --- BROADCASTER MODE ---
        async function initBroadcasterMode() {
            document.getElementById('select-screen').classList.add('hidden');
            document.getElementById('broadcaster-screen').classList.remove('hidden');
            
            try { 
                wakeLock = await navigator.wakeLock.request('screen'); 
                log("üîã WakeLock Active"); 
            } catch (e) {}

            socket.emit('broadcaster');
            log("üì° Standby: Waiting for viewers...");
            
            // Pre-warm permissions
            try {
                const temp = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                temp.getTracks().forEach(t => t.stop());
            } catch(e) {
                log("‚ö†Ô∏è Camera permission needed");
            }
        }

        // Handle each viewer individually
        socket.on('watcher', async (viewerId) => {
            log(`üìû Viewer ${viewerId} connected (Total: ${++activeViewers})`);
            updateViewerCount(activeViewers);
            
            // Start camera ONLY if not already running
            if (!localStream) {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' }, 
                        audio: true 
                    });
                    document.getElementById('localVideo').srcObject = localStream;
                    log("‚úÖ Camera ON");
                } catch (e) {
                    log("‚ùå Camera failed: " + e.message);
                    return;
                }
            }

            // Enter stealth for THIS viewer
            document.getElementById('stealth-overlay').classList.remove('hidden');
            
            // Create peer connection for THIS viewer
            const peer = new RTCPeerConnection(config);
            peerConnections[viewerId] = peer;
            
            localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
            
            peer.onicecandidate = event => {
                if (event.candidate) socket.emit('candidate', viewerId, event.candidate);
            };
            
            const offer = await peer.createOffer();
            await peer.setLocalDescription(offer);
            socket.emit('offer', viewerId, peer.localDescription);
        });

        // Handle answers from each viewer
        socket.on('answer', (viewerId, desc) => {
            if (peerConnections[viewerId]) {
                peerConnections[viewerId].setRemoteDescription(desc);
            }
        });

        socket.on('candidate', (viewerId, cand) => {
            if (peerConnections[viewerId]) {
                peerConnections[viewerId].addIceCandidate(new RTCIceCandidate(cand));
            }
        });

        // Handle viewer leaving
        socket.on('viewer_left', (viewerId) => {
            log(`üëã Viewer ${viewerId} left (Remaining: ${--activeViewers})`);
            updateViewerCount(activeViewers);
        });

        // ALL viewers gone - go to standby
        socket.on('all_viewers_left', () => {
            log("üè† ALL viewers gone - returning to standby");
            activeViewers = 0;
            updateViewerCount(0);
            
            // Stop camera to save battery
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                log("‚úÖ Camera OFF (battery saving)");
            }
            
            // Close all peer connections
            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};
            
            // Exit stealth
            document.getElementById('stealth-overlay').classList.add('hidden');
        });

        function updateViewerCount(count) {
            document.getElementById('viewer-count').textContent = `Viewers: ${count}`;
            document.getElementById('broadcaster-status').textContent = 
                count > 0 ? "‚óè Broadcasting Live" : "‚óè Waiting for viewers...";
        }

        function wakeUpScreen() {
            document.getElementById('stealth-overlay').classList.add('hidden');
        }

        // --- VIEWER MODE ---
        function initCallerMode() {
            document.getElementById('select-screen').classList.add('hidden');
            document.getElementById('caller-screen').classList.remove('hidden');
            log("üìû Calling camera...");
            socket.emit('watcher');
        }

        socket.on('offer', async (id, description) => {
            const peer = new RTCPeerConnection(config);
            peerConnections[id] = peer;
            
            peer.onicecandidate = event => {
                if (event.candidate) socket.emit('candidate', id, event.candidate);
            };
            
            peer.ontrack = event => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
                log("‚úÖ Video stream received");
            };
            
            await peer.setRemoteDescription(description);
            const answer = await peer.createAnswer();
            await peer.setLocalDescription(answer);
            socket.emit('answer', id, peer.localDescription);
        });

        function endCall() {
            socket.disconnect();
            location.reload();
        }

        socket.on('broadcaster_left', () => {
            log("üì¥ Camera went offline");
            location.reload();
        });

        socket.on('no_broadcaster', () => {
            log("‚ùå No camera available");
            alert("No camera online. Start camera first.");
            location.reload();
        });
    </script>
</body>
</html>
